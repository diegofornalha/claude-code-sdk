<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - M√∫ltiplas Mensagens Simult√¢neas</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { color: #0ff; }
        button {
            background: #003300;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
        }
        button:hover { background: #005500; }
        #results {
            margin-top: 20px;
            border: 1px solid #0f0;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .message {
            padding: 5px;
            margin: 5px 0;
            border-left: 3px solid #0f0;
            padding-left: 10px;
        }
        .error { border-left-color: #f00; color: #f99; }
        .success { border-left-color: #0f0; color: #9f9; }
        .pending { border-left-color: #ff0; color: #ff9; }
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #111;
            border: 1px solid #0f0;
            padding: 10px;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <h1>üöÄ Teste de M√∫ltiplas Mensagens Simult√¢neas</h1>

    <div>
        <button onclick="sendSingleMessage()">Enviar 1 Mensagem</button>
        <button onclick="send3Messages()">Enviar 3 Simult√¢neas</button>
        <button onclick="send10Messages()">Enviar 10 Simult√¢neas</button>
        <button onclick="stressTest()">Stress Test (20)</button>
        <button onclick="clearResults()" style="background: #330000;">Limpar</button>
    </div>

    <div id="status">
        <strong>Status</strong>
        <div>Requisi√ß√µes Ativas: <span id="activeCount">0</span></div>
        <div>Total Enviadas: <span id="totalCount">0</span></div>
        <div>Sucesso: <span id="successCount">0</span></div>
        <div>Erro: <span id="errorCount">0</span></div>
    </div>

    <div id="results"></div>

    <script>
        const API_URL = 'http://localhost:8080/api/chat';
        let activeRequests = 0;
        let totalRequests = 0;
        let successCount = 0;
        let errorCount = 0;

        function updateStatus() {
            document.getElementById('activeCount').textContent = activeRequests;
            document.getElementById('totalCount').textContent = totalRequests;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('errorCount').textContent = errorCount;
        }

        function addResult(message, type = 'pending') {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
            document.getElementById('results').scrollTop = document.getElementById('results').scrollHeight;
            return div;
        }

        async function sendMessage(text, id) {
            activeRequests++;
            totalRequests++;
            updateStatus();

            const msgDiv = addResult(`üì§ #${id}: Enviando "${text}"...`, 'pending');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let responseText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'content') {
                                    responseText += data.content;
                                } else if (data.type === 'done') {
                                    successCount++;
                                    msgDiv.className = 'message success';
                                    msgDiv.innerHTML = `‚úÖ #${id}: Resposta completa (${responseText.length} chars)`;
                                }
                            } catch (e) {}
                        }
                    }
                }

            } catch (error) {
                errorCount++;
                msgDiv.className = 'message error';
                msgDiv.innerHTML = `‚ùå #${id}: ${error.message}`;
            } finally {
                activeRequests--;
                updateStatus();
            }
        }

        function sendSingleMessage() {
            sendMessage('Teste √∫nico ' + Date.now(), totalRequests + 1);
        }

        function send3Messages() {
            for (let i = 1; i <= 3; i++) {
                sendMessage(`Mensagem ${i} de 3`, totalRequests + i);
            }
        }

        function send10Messages() {
            for (let i = 1; i <= 10; i++) {
                setTimeout(() => {
                    sendMessage(`Batch 10 - Msg ${i}`, totalRequests + 1);
                }, i * 100); // Pequeno delay para n√£o sobrecarregar
            }
        }

        function stressTest() {
            addResult('üî• Iniciando stress test com 20 mensagens...', 'pending');
            for (let i = 1; i <= 20; i++) {
                setTimeout(() => {
                    sendMessage(`Stress ${i}/20`, totalRequests + 1);
                }, i * 50);
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            activeRequests = 0;
            totalRequests = 0;
            successCount = 0;
            errorCount = 0;
            updateStatus();
        }

        // Teste inicial
        addResult('‚úÖ Sistema pronto para testar m√∫ltiplas mensagens simult√¢neas!', 'success');
        addResult('Clique nos bot√µes acima para enviar mensagens em paralelo.', 'success');
    </script>
</body>
</html>